# inform travis that we are building a cpp project
language: cpp

# send build status notifications to tulipdev mailing list
notifications:
  email:
    - tulipdev@labri.fr

# define build jobs
jobs:
  include:
  #==============================================================================================================================================================
    # Tulip AppImage build on CentOS
    - stage: Tulip AppImage build (CentOS)
      # Tulip x86_64 AppImage build on CentOS 6
      os: linux
      dist: trusty
      cache:
        directories:
          - $HOME/ccache

      sudo: required
      env:
        - ARCH=x86_64
        - DOCKER_IMAGE=centos:6

      services:
        - docker

      before_script:
        - "export DISPLAY=:99.0"
        - "sh -e /etc/init.d/xvfb start"
        - sleep 3 # give xvfb some time to start

      before_install:
        - echo 'DOCKER_OPTS="-H tcp://127.0.0.1:2375 -H unix:///var/run/docker.sock -s devicemapper"' | sudo tee /etc/default/docker > /dev/null
        - sudo service docker restart
        - sleep 5
        - sudo docker pull ${DOCKER_IMAGE}
        - sudo docker create -v $HOME/ccache:/ccache --name ccache ${DOCKER_IMAGE}

      script:
        - sudo docker run --rm=true -e CCACHE_DIR=/ccache --volumes-from ccache --cap-add SYS_ADMIN --device /dev/fuse:/dev/fuse:mrw --rm=true -v `pwd`:/tulip:rw ${DOCKER_IMAGE} /bin/bash -c "bash -xe /tulip/bundlers/linux/tulip_appimage_centos6_build.sh"
        - git clone -b for-use-on-travis https://github.com/anlambert/appimage-testsuite.git
        - cd appimage-testsuite
        - sudo ./run.sh $PWD/../build/Tulip-5.3.0-dev-x86_64.AppImage debian-stable
        - sudo ./run.sh $PWD/../build/Tulip-5.3.0-dev-x86_64.AppImage debian-testing
        - sudo ./run.sh $PWD/../build/Tulip-5.3.0-dev-x86_64.AppImage ubuntu-16.04
        - sudo ./run.sh $PWD/../build/Tulip-5.3.0-dev-x86_64.AppImage ubuntu-18.04
